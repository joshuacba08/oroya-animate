<!-- Mermaid CDN + pako for Mermaid Live links -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js" is:inline></script>
<script src="https://cdn.jsdelivr.net/npm/pako@2/dist/pako.min.js" is:inline></script>

<script is:inline>
  document.addEventListener("DOMContentLoaded", function () {
    var blocks = document.querySelectorAll('pre[data-language="mermaid"]');
    if (blocks.length === 0) return;

    var isDark =
      document.documentElement.getAttribute("data-theme") === "night" ||
      document.documentElement.getAttribute("data-theme") === "dark";

    mermaid.initialize({
      startOnLoad: false,
      theme: isDark ? "dark" : "default",
      fontFamily: "Inter, sans-serif",
    });

    // Store original source per container for Mermaid Live links
    var sourceMap = new Map();

    blocks.forEach(function (pre) {
      var text = pre.textContent.trim();
      if (!text) return;

      // Create the wrapper structure
      var wrapper = document.createElement("div");
      wrapper.className = "mermaid-container";

      // Toolbar
      var toolbar = document.createElement("div");
      toolbar.className = "mermaid-toolbar";
      toolbar.innerHTML =
        '<button class="mermaid-btn" data-action="zoom-in" title="Zoom in">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>' +
        "</button>" +
        '<button class="mermaid-btn" data-action="zoom-out" title="Zoom out">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>' +
        "</button>" +
        '<button class="mermaid-btn" data-action="reset" title="Reset view">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>' +
        "</button>" +
        '<div class="mermaid-toolbar-sep"></div>' +
        '<button class="mermaid-btn" data-action="fullscreen" title="Fullscreen">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>' +
        "</button>" +
        '<button class="mermaid-btn" data-action="mermaid-live" title="Open in Mermaid Live Editor">' +
        '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>' +
        "</button>";
      wrapper.appendChild(toolbar);

      // Viewport for pan & zoom
      var viewport = document.createElement("div");
      viewport.className = "mermaid-viewport";

      // Mermaid render target
      var mermaidDiv = document.createElement("div");
      mermaidDiv.className = "mermaid";
      mermaidDiv.textContent = text;
      viewport.appendChild(mermaidDiv);

      wrapper.appendChild(viewport);
      pre.replaceWith(wrapper);

      sourceMap.set(wrapper, text);
    });

    // Render all mermaid diagrams
    mermaid
      .run({ nodes: document.querySelectorAll(".mermaid") })
      .then(function () {
        // After rendering, initialize pan & zoom on each container
        document.querySelectorAll(".mermaid-container").forEach(function (container) {
          initPanZoom(container, sourceMap.get(container) || "");
        });
      });

    function initPanZoom(container, source) {
      var viewport = container.querySelector(".mermaid-viewport");
      var mermaidEl = container.querySelector(".mermaid");
      if (!viewport || !mermaidEl) return;

      var state = { scale: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 };
      var MIN_SCALE = 0.3;
      var MAX_SCALE = 5;

      function applyTransform() {
        mermaidEl.style.transform =
          "translate(" + state.x + "px, " + state.y + "px) scale(" + state.scale + ")";
      }

      function zoomTo(newScale, cx, cy) {
        newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, newScale));
        var ratio = newScale / state.scale;
        state.x = cx - ratio * (cx - state.x);
        state.y = cy - ratio * (cy - state.y);
        state.scale = newScale;
        applyTransform();
      }

      function reset() {
        state.scale = 1;
        state.x = 0;
        state.y = 0;
        applyTransform();
      }

      // Wheel zoom
      viewport.addEventListener("wheel", function (e) {
        e.preventDefault();
        var rect = viewport.getBoundingClientRect();
        var cx = e.clientX - rect.left;
        var cy = e.clientY - rect.top;
        var factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
        zoomTo(state.scale * factor, cx, cy);
      }, { passive: false });

      // Mouse drag
      viewport.addEventListener("mousedown", function (e) {
        if (e.button !== 0) return;
        state.dragging = true;
        state.startX = e.clientX - state.x;
        state.startY = e.clientY - state.y;
        viewport.style.cursor = "grabbing";
        e.preventDefault();
      });

      document.addEventListener("mousemove", function (e) {
        if (!state.dragging) return;
        state.x = e.clientX - state.startX;
        state.y = e.clientY - state.startY;
        applyTransform();
      });

      document.addEventListener("mouseup", function () {
        if (state.dragging) {
          state.dragging = false;
          viewport.style.cursor = "grab";
        }
      });

      // Touch support
      var lastTouchDist = 0;
      viewport.addEventListener("touchstart", function (e) {
        if (e.touches.length === 1) {
          state.dragging = true;
          state.startX = e.touches[0].clientX - state.x;
          state.startY = e.touches[0].clientY - state.y;
        } else if (e.touches.length === 2) {
          state.dragging = false;
          lastTouchDist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
        }
        e.preventDefault();
      }, { passive: false });

      viewport.addEventListener("touchmove", function (e) {
        if (e.touches.length === 1 && state.dragging) {
          state.x = e.touches[0].clientX - state.startX;
          state.y = e.touches[0].clientY - state.startY;
          applyTransform();
        } else if (e.touches.length === 2) {
          var dist = Math.hypot(
            e.touches[0].clientX - e.touches[1].clientX,
            e.touches[0].clientY - e.touches[1].clientY
          );
          if (lastTouchDist > 0) {
            var rect = viewport.getBoundingClientRect();
            var cx = (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left;
            var cy = (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top;
            zoomTo(state.scale * (dist / lastTouchDist), cx, cy);
          }
          lastTouchDist = dist;
        }
        e.preventDefault();
      }, { passive: false });

      viewport.addEventListener("touchend", function () {
        state.dragging = false;
        lastTouchDist = 0;
      });

      // Toolbar buttons
      container.querySelectorAll(".mermaid-btn").forEach(function (btn) {
        btn.addEventListener("click", function (e) {
          e.stopPropagation();
          var action = btn.getAttribute("data-action");
          var rect = viewport.getBoundingClientRect();
          var cx = rect.width / 2;
          var cy = rect.height / 2;

          if (action === "zoom-in") {
            zoomTo(state.scale * 1.3, cx, cy);
          } else if (action === "zoom-out") {
            zoomTo(state.scale / 1.3, cx, cy);
          } else if (action === "reset") {
            reset();
          } else if (action === "fullscreen") {
            openFullscreen(container, source);
          } else if (action === "mermaid-live") {
            openMermaidLive(source);
          }
        });
      });
    }

    // ── Fullscreen modal ──────────────────────────────────────────────
    function openFullscreen(container, source) {
      var svgEl = container.querySelector(".mermaid svg");
      if (!svgEl) return;

      var overlay = document.createElement("div");
      overlay.className = "mermaid-fullscreen-overlay";

      var closeBtn = document.createElement("button");
      closeBtn.className = "mermaid-fullscreen-close";
      closeBtn.innerHTML =
        '<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
      closeBtn.title = "Close (Esc)";
      overlay.appendChild(closeBtn);

      // Toolbar inside fullscreen
      var fsToolbar = document.createElement("div");
      fsToolbar.className = "mermaid-fullscreen-toolbar";
      fsToolbar.innerHTML =
        '<button class="mermaid-btn mermaid-btn-lg" data-action="zoom-in" title="Zoom in">' +
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>' +
        "</button>" +
        '<button class="mermaid-btn mermaid-btn-lg" data-action="zoom-out" title="Zoom out">' +
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>' +
        "</button>" +
        '<button class="mermaid-btn mermaid-btn-lg" data-action="reset" title="Reset view">' +
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>' +
        "</button>" +
        '<button class="mermaid-btn mermaid-btn-lg" data-action="mermaid-live" title="Open in Mermaid Live">' +
        '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>' +
        "</button>";
      overlay.appendChild(fsToolbar);

      // SVG viewport inside fullscreen
      var fsViewport = document.createElement("div");
      fsViewport.className = "mermaid-fullscreen-viewport";
      var svgClone = svgEl.cloneNode(true);
      svgClone.style.maxWidth = "none";
      svgClone.style.width = "auto";
      svgClone.style.height = "auto";
      fsViewport.appendChild(svgClone);
      overlay.appendChild(fsViewport);

      document.body.appendChild(overlay);
      document.body.style.overflow = "hidden";

      // Init pan & zoom for fullscreen
      var fsState = { scale: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 };

      function fsApply() {
        svgClone.style.transform =
          "translate(" + fsState.x + "px, " + fsState.y + "px) scale(" + fsState.scale + ")";
      }

      function fsZoom(newScale, cx, cy) {
        newScale = Math.max(0.2, Math.min(8, newScale));
        var ratio = newScale / fsState.scale;
        fsState.x = cx - ratio * (cx - fsState.x);
        fsState.y = cy - ratio * (cy - fsState.y);
        fsState.scale = newScale;
        fsApply();
      }

      function fsReset() {
        fsState = { scale: 1, x: 0, y: 0, dragging: false, startX: 0, startY: 0 };
        fsApply();
      }

      fsViewport.addEventListener("wheel", function (e) {
        e.preventDefault();
        var rect = fsViewport.getBoundingClientRect();
        var factor = e.deltaY < 0 ? 1.15 : 1 / 1.15;
        fsZoom(fsState.scale * factor, e.clientX - rect.left, e.clientY - rect.top);
      }, { passive: false });

      fsViewport.addEventListener("mousedown", function (e) {
        if (e.button !== 0) return;
        fsState.dragging = true;
        fsState.startX = e.clientX - fsState.x;
        fsState.startY = e.clientY - fsState.y;
        fsViewport.style.cursor = "grabbing";
        e.preventDefault();
      });

      var onMove = function (e) {
        if (!fsState.dragging) return;
        fsState.x = e.clientX - fsState.startX;
        fsState.y = e.clientY - fsState.startY;
        fsApply();
      };

      var onUp = function () {
        fsState.dragging = false;
        fsViewport.style.cursor = "grab";
      };

      document.addEventListener("mousemove", onMove);
      document.addEventListener("mouseup", onUp);

      // Toolbar actions
      fsToolbar.querySelectorAll(".mermaid-btn").forEach(function (btn) {
        btn.addEventListener("click", function (e) {
          e.stopPropagation();
          var action = btn.getAttribute("data-action");
          var rect = fsViewport.getBoundingClientRect();
          var cx = rect.width / 2;
          var cy = rect.height / 2;
          if (action === "zoom-in") fsZoom(fsState.scale * 1.3, cx, cy);
          else if (action === "zoom-out") fsZoom(fsState.scale / 1.3, cx, cy);
          else if (action === "reset") fsReset();
          else if (action === "mermaid-live") openMermaidLive(source);
        });
      });

      // Close handlers
      function closeOverlay() {
        document.removeEventListener("mousemove", onMove);
        document.removeEventListener("mouseup", onUp);
        document.removeEventListener("keydown", escHandler);
        overlay.remove();
        document.body.style.overflow = "";
      }

      closeBtn.addEventListener("click", closeOverlay);
      overlay.addEventListener("click", function (e) {
        if (e.target === overlay) closeOverlay();
      });

      var escHandler = function (e) {
        if (e.key === "Escape") closeOverlay();
      };
      document.addEventListener("keydown", escHandler);
    }

    // ── Open in Mermaid Live ──────────────────────────────────────────
    function openMermaidLive(source) {
      try {
        var state = JSON.stringify({
          code: source,
          mermaid: { theme: "default" },
          autoSync: true,
          updateDiagram: true,
        });

        var data = new TextEncoder().encode(state);
        var compressed = pako.deflate(data, { level: 9 });

        // base64url encode
        var b64 = btoa(String.fromCharCode.apply(null, compressed))
          .replace(/\+/g, "-")
          .replace(/\//g, "_")
          .replace(/=+$/, "");

        window.open("https://mermaid.live/edit#pako:" + b64, "_blank");
      } catch (err) {
        console.error("Failed to open Mermaid Live:", err);
        window.open("https://mermaid.live/", "_blank");
      }
    }
  });
</script>

<style is:global>
  /* ── Container ──────────────────────────────────────────────────── */
  .mermaid-container {
    position: relative;
    margin: 1.5rem 0;
    border-radius: 0.75rem;
    overflow: hidden;
  }

  [data-theme="dark"] .mermaid-container,
  [data-theme="night"] .mermaid-container {
    background: oklch(0.15 0.03 265 / 0.5);
    border: 1px solid oklch(0.3 0.03 265 / 0.4);
  }

  [data-theme="light"] .mermaid-container {
    background: oklch(0.97 0.01 265 / 0.6);
    border: 1px solid oklch(0.85 0.02 265 / 0.4);
  }

  /* ── Toolbar ────────────────────────────────────────────────────── */
  .mermaid-toolbar {
    display: flex;
    align-items: center;
    gap: 0.25rem;
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid oklch(0.5 0 0 / 0.1);
    opacity: 0.6;
    transition: opacity 0.2s ease;
  }

  .mermaid-container:hover .mermaid-toolbar {
    opacity: 1;
  }

  .mermaid-toolbar-sep {
    width: 1px;
    height: 1.25rem;
    margin: 0 0.25rem;
    opacity: 0.2;
  }

  [data-theme="dark"] .mermaid-toolbar-sep,
  [data-theme="night"] .mermaid-toolbar-sep {
    background: white;
  }

  [data-theme="light"] .mermaid-toolbar-sep {
    background: black;
  }

  .mermaid-btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 2rem;
    height: 2rem;
    border: none;
    border-radius: 0.375rem;
    background: transparent;
    cursor: pointer;
    transition: background 0.15s ease, color 0.15s ease;
  }

  [data-theme="dark"] .mermaid-btn,
  [data-theme="night"] .mermaid-btn {
    color: oklch(0.8 0 0);
  }

  [data-theme="light"] .mermaid-btn {
    color: oklch(0.3 0 0);
  }

  .mermaid-btn:hover {
    background: oklch(0.5 0 0 / 0.15);
  }

  .mermaid-btn-lg {
    width: 2.5rem;
    height: 2.5rem;
  }

  /* ── Viewport (pan & zoom area) ─────────────────────────────────── */
  .mermaid-viewport {
    overflow: hidden;
    cursor: grab;
    min-height: 200px;
  }

  .mermaid-viewport:active {
    cursor: grabbing;
  }

  .mermaid-viewport .mermaid {
    display: flex;
    justify-content: center;
    padding: 1.5rem;
    transform-origin: 0 0;
    transition: none;
    will-change: transform;
    background: none !important;
    border: none !important;
    margin: 0 !important;
  }

  .mermaid-viewport .mermaid svg {
    max-width: none;
    height: auto;
  }

  /* ── Fullscreen overlay ─────────────────────────────────────────── */
  .mermaid-fullscreen-overlay {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
    background: oklch(0.1 0 0 / 0.92);
    backdrop-filter: blur(8px);
  }

  .mermaid-fullscreen-close {
    position: absolute;
    top: 1rem;
    right: 1rem;
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 3rem;
    height: 3rem;
    border: 1px solid oklch(0.5 0 0 / 0.3);
    border-radius: 0.5rem;
    background: oklch(0.2 0 0 / 0.6);
    color: white;
    cursor: pointer;
    transition: background 0.15s ease;
  }

  .mermaid-fullscreen-close:hover {
    background: oklch(0.3 0 0 / 0.8);
  }

  .mermaid-fullscreen-toolbar {
    position: absolute;
    bottom: 1.5rem;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10001;
    display: flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.5rem 0.75rem;
    border-radius: 0.75rem;
    border: 1px solid oklch(0.5 0 0 / 0.3);
    background: oklch(0.15 0 0 / 0.8);
    backdrop-filter: blur(12px);
  }

  .mermaid-fullscreen-toolbar .mermaid-btn {
    color: oklch(0.85 0 0);
  }

  .mermaid-fullscreen-toolbar .mermaid-btn:hover {
    background: oklch(0.5 0 0 / 0.25);
  }

  .mermaid-fullscreen-viewport {
    width: 100%;
    height: 100%;
    overflow: hidden;
    cursor: grab;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .mermaid-fullscreen-viewport:active {
    cursor: grabbing;
  }

  .mermaid-fullscreen-viewport svg {
    transform-origin: 0 0;
    will-change: transform;
  }
</style>
