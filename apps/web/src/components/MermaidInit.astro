---
/**
 * MermaidInit â€” client-side Mermaid diagram renderer.
 * Finds all `<code class="language-mermaid">` blocks produced by Astro's
 * markdown pipeline and replaces them with rendered SVG diagrams.
 *
 * Drop this component once inside any layout that renders markdown with
 * mermaid fenced code blocks.
 */
---

<script>
  import mermaid from "mermaid";

  function initMermaid() {
    mermaid.initialize({
      startOnLoad: false,
      theme: "dark",
      themeVariables: {
        primaryColor: "#a78bfa",
        primaryTextColor: "#e2e8f0",
        primaryBorderColor: "#7c3aed",
        secondaryColor: "#1e293b",
        tertiaryColor: "#0f172a",
        lineColor: "#60a5fa",
        textColor: "#e2e8f0",
        mainBkg: "#1e1b4b",
        nodeBorder: "#7c3aed",
        clusterBkg: "#1e1b4b22",
        clusterBorder: "#4c1d95",
        titleColor: "#e2e8f0",
        edgeLabelBackground: "#1e1b4b",
        nodeTextColor: "#e2e8f0",
      },
      fontFamily: '"Inter", ui-sans-serif, system-ui, sans-serif',
      flowchart: { htmlLabels: true, curve: "basis" },
      securityLevel: "loose",
    });

    const codeBlocks = document.querySelectorAll<HTMLElement>(
      "pre > code.language-mermaid"
    );

    codeBlocks.forEach(async (codeEl, idx) => {
      const pre = codeEl.parentElement;
      if (!pre) return;

      const graphDefinition = codeEl.textContent?.trim() ?? "";
      if (!graphDefinition) return;

      const id = `mermaid-diagram-${idx}`;

      try {
        const { svg } = await mermaid.render(id, graphDefinition);

        const wrapper = document.createElement("div");
        wrapper.className = "mermaid-diagram";
        wrapper.innerHTML = svg;

        pre.replaceWith(wrapper);
      } catch (err) {
        console.error(`[MermaidInit] Failed to render diagram #${idx}:`, err);
      }
    });
  }

  // Run after DOM is ready
  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMermaid);
  } else {
    initMermaid();
  }

  // Support Astro view transitions
  document.addEventListener("astro:after-swap", initMermaid);
</script>

<style is:global>
  .mermaid-diagram {
    display: flex;
    justify-content: center;
    margin: 1.5rem 0;
    padding: 1.5rem;
    border-radius: 0.75rem;
    background: oklch(0.15 0.03 265 / 0.5);
    border: 1px solid oklch(0.3 0.03 265 / 0.4);
    overflow-x: auto;
  }

  .mermaid-diagram svg {
    max-width: 100%;
    height: auto;
  }
</style>
